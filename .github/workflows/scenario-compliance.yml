name: Documentation Compliance Check

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 06:00 MSK (03:00 UTC)
    - cron: '0 3 * * *'
  workflow_dispatch:
    # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
    inputs:
      check_type:
        description: '–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - scenarios
          - processes
          - data
          - states

jobs:
  check-compliance:
    name: Check Code vs Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Run compliance checks
        id: check
        run: |
          CHECK_TYPE="${{ github.event.inputs.check_type || 'all' }}"

          python -m tests.test_repo.scripts.checker --type $CHECK_TYPE --json > result.json
          cat result.json

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
          COVERAGE=$(jq -r '.coverage' result.json)
          STATUS=$(jq -r '.status' result.json)

          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "check_type=$CHECK_TYPE" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate report files
        run: |
          CHECK_TYPE="${{ github.event.inputs.check_type || 'all' }}"
          python -m tests.test_repo.scripts.checker --type $CHECK_TYPE

      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compliance-reports
          path: tests/test-repo/reports/*.md
          retention-days: 90

      - name: Commit reports to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add tests/test-repo/reports/*.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(date +%Y-%m-%d)
            CHECK_TYPE="${{ steps.check.outputs.check_type }}"
            git commit -m "chore: add compliance report for $DATE ($CHECK_TYPE)"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          COVERAGE=${{ steps.check.outputs.coverage }}
          STATUS=${{ steps.check.outputs.status }}
          CHECK_TYPE=${{ steps.check.outputs.check_type }}

          if [ "$STATUS" = "green" ]; then
            EMOJI="üü¢"
            MESSAGE="–ö–æ–¥ —Ö–æ—Ä–æ—à–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
          elif [ "$STATUS" = "yellow" ]; then
            EMOJI="üü°"
            MESSAGE="–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã"
          else
            EMOJI="üî¥"
            MESSAGE="–ö—Ä–∏—Ç–∏—á–Ω–æ: –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã"
          fi

          echo "## $EMOJI –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏:** $CHECK_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "**–ü–æ–∫—Ä—ã—Ç–∏–µ:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$MESSAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### –ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:" >> $GITHUB_STEP_SUMMARY
          echo "- **scenarios** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è–º" >> $GITHUB_STEP_SUMMARY
          echo "- **processes** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º" >> $GITHUB_STEP_SUMMARY
          echo "- **data** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã–º" >> $GITHUB_STEP_SUMMARY
          echo "- **states** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ State Machine" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö." >> $GITHUB_STEP_SUMMARY

      - name: Fail if coverage is critical
        if: steps.check.outputs.status == 'red'
        run: |
          echo "‚ùå –ü–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–æ–µ: ${{ steps.check.outputs.coverage }}%"
          exit 1
