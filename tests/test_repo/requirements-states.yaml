# ТЗ для проверки соответствия State Machine документации
# ========================================================
# Этот файл определяет маппинг между состояниями (стейтами)
# и их реализацией в коде.

version: "1.0"
source: "config/transitions.yaml"

# Веса для расчёта покрытия
weights:
  critical: 2
  normal: 1

thresholds:
  green: 90
  yellow: 70

# ===========================================
# ИНФРАСТРУКТУРА STATE MACHINE
# ===========================================
infrastructure:
  name: "Инфраструктура State Machine"
  priority: critical

  checks:
    # BaseState
    - type: class
      file: "states/base.py"
      name: "BaseState"
      description: "Базовый класс стейтов"
      required: true

    # StateMachine
    - type: class
      file: "core/machine.py"
      name: "StateMachine"
      description: "Движок переходов"
      required: true

    # StateStorage
    - type: class
      file: "core/storage.py"
      name: "StateStorage"
      description: "Хранение состояний"
      required: true

    # FeatureFlags
    - type: class
      file: "config/features.py"
      name: "FeatureFlags"
      description: "Feature flags"
      required: true

    # Таблица переходов
    - type: file
      file: "config/transitions.yaml"
      description: "Таблица переходов"
      required: true

    # Реестр стейтов
    - type: function
      file: "states/registry.py"
      name: "register_all_states"
      description: "Регистрация стейтов"
      required: true

# ===========================================
# COMMON СТЕЙТЫ
# ===========================================
states_common:
  name: "Общие стейты (common)"
  priority: critical

  checks:
    # StartState
    - type: class
      file: "states/common/start.py"
      name: "StartState"
      description: "Стейт начала работы"
      required: true

    - type: pattern
      file: "states/common/start.py"
      pattern: "name\\s*=\\s*[\"']common\\.start[\"']"
      description: "Имя стейта common.start"
      required: true

    # ErrorState
    - type: class
      file: "states/common/error.py"
      name: "ErrorState"
      description: "Стейт обработки ошибок"
      required: true

    - type: pattern
      file: "states/common/error.py"
      pattern: "name\\s*=\\s*[\"']common\\.error[\"']"
      description: "Имя стейта common.error"
      required: true

    # ModeSelectState
    - type: class
      file: "states/common/mode_select.py"
      name: "ModeSelectState"
      description: "Стейт выбора режима"
      required: true

    - type: pattern
      file: "states/common/mode_select.py"
      pattern: "name\\s*=\\s*[\"']common\\.mode_select[\"']"
      description: "Имя стейта common.mode_select"
      required: true

# ===========================================
# MARATHON СТЕЙТЫ (Неделя 2)
# ===========================================
states_marathon:
  name: "Стейты Марафона (workshop.marathon)"
  priority: critical

  checks:
    # MarathonDayState
    - type: class
      file: "states/workshops/marathon/day.py"
      name: "MarathonDayState"
      description: "Стейт показа урока"
      required: false  # TODO: Неделя 2

    # MarathonQuestionState
    - type: class
      file: "states/workshops/marathon/question.py"
      name: "MarathonQuestionState"
      description: "Стейт вопроса урока"
      required: false  # TODO: Неделя 2

    # MarathonTaskState
    - type: class
      file: "states/workshops/marathon/task.py"
      name: "MarathonTaskState"
      description: "Стейт задания"
      required: false  # TODO: Неделя 2

# ===========================================
# CONSULTANT СТЕЙТЫ (Неделя 3-4)
# ===========================================
states_consultants:
  name: "Стейты консультантов"
  priority: normal

  checks:
    # MainConsultantState
    - type: class
      file: "states/consultants/main.py"
      name: "MainConsultantState"
      description: "Общий консультант"
      required: false  # TODO: Неделя 3

    # FeedTopicsState
    - type: class
      file: "states/consultants/feed_topics.py"
      name: "FeedTopicsState"
      description: "Выбор тем Ленты"
      required: false  # TODO: Неделя 4

    # FeedDigestState
    - type: class
      file: "states/consultants/feed_digest.py"
      name: "FeedDigestState"
      description: "Показ дайджеста"
      required: false  # TODO: Неделя 4

# ===========================================
# UTILITY СТЕЙТЫ (Неделя 6)
# ===========================================
states_utilities:
  name: "Стейты утилит"
  priority: normal

  checks:
    # NotesState
    - type: class
      file: "states/utilities/notes.py"
      name: "NotesState"
      description: "Заметочник"
      required: false  # TODO: Неделя 6

    # ExportState
    - type: class
      file: "states/utilities/export.py"
      name: "ExportState"
      description: "Экспорт данных"
      required: false  # TODO: Неделя 6

# ===========================================
# ЛОКАЛИЗАЦИЯ (i18n)
# ===========================================
localization:
  name: "Система локализации"
  priority: normal

  checks:
    # I18n class
    - type: class
      file: "i18n/loader.py"
      name: "I18n"
      description: "Класс локализации"
      required: true

    # Русские переводы
    - type: file
      file: "i18n/ru/common.yaml"
      description: "Русские общие строки"
      required: true

    - type: file
      file: "i18n/ru/states.yaml"
      description: "Русские строки стейтов"
      required: true

    # Английские переводы
    - type: file
      file: "i18n/en/common.yaml"
      description: "Английские общие строки"
      required: true

    - type: file
      file: "i18n/en/states.yaml"
      description: "Английские строки стейтов"
      required: true

# ===========================================
# СООТВЕТСТВИЕ transitions.yaml И КОДА
# ===========================================
transitions_consistency:
  name: "Консистентность таблицы переходов"
  priority: critical

  # Каждый стейт из transitions.yaml должен:
  # 1. Иметь соответствующий класс в states/
  # 2. Иметь правильное значение name
  # 3. Быть зарегистрирован в registry.py

  checks:
    # common.start
    - type: transition
      state: "common.start"
      class_file: "states/common/start.py"
      events: ["new_user", "onboarding_complete", "existing_user", "error"]
      required: true

    # common.error
    - type: transition
      state: "common.error"
      class_file: "states/common/error.py"
      events: ["retry", "continue"]
      required: true

    # common.mode_select
    - type: transition
      state: "common.mode_select"
      class_file: "states/common/mode_select.py"
      events: ["marathon", "feed", "settings"]
      required: true

    # workshop.marathon.day (Неделя 2)
    - type: transition
      state: "workshop.marathon.day"
      class_file: "states/workshops/marathon/day.py"
      events: ["lesson_shown", "already_completed", "marathon_complete"]
      required: false  # TODO: Неделя 2

    # workshop.marathon.question (Неделя 2)
    - type: transition
      state: "workshop.marathon.question"
      class_file: "states/workshops/marathon/question.py"
      events: ["correct", "incorrect", "skip", "hint"]
      required: false  # TODO: Неделя 2

    # workshop.marathon.task (Неделя 2)
    - type: transition
      state: "workshop.marathon.task"
      class_file: "states/workshops/marathon/task.py"
      events: ["submitted", "feedback_requested", "day_complete"]
      required: false  # TODO: Неделя 2

# ===========================================
# FEATURE FLAGS CONSISTENCY
# ===========================================
feature_flags_consistency:
  name: "Консистентность Feature Flags"
  priority: normal

  checks:
    # Главный переключатель
    - type: pattern
      file: "config/features.yaml"
      pattern: "use_state_machine:\\s*(true|false)"
      description: "Флаг use_state_machine"
      required: true

    # Workshops
    - type: pattern
      file: "config/features.yaml"
      pattern: "marathon:\\s*\\n\\s*enabled:"
      description: "Флаг marathon.enabled"
      required: true

    # Consultants
    - type: pattern
      file: "config/features.yaml"
      pattern: "feed:\\s*\\n\\s*enabled:"
      description: "Флаг feed.enabled"
      required: true
